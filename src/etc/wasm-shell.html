<!doctype html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>rv32-sail RISC-V Emulation</title>
  <style>
    html {
      height: 100%;
    }

    body {
      position: absolute;
      height: 100%;
      width: 100%;
      overflow: hidden;
      margin: 0px;
      padding: 0px;
    }

    #terminal {
      display: block;
      position: relative;
      height: 100%;
      width: 100%;
      margin: 0px;
      padding: 0px;
    }
    </style>
</head>

<body>
  <div id='terminal'></div>
  <script type='text/javascript'>
    const esc = `\x1b`;
    const bel = `\x07`;
    const clrln = `${esc}[2;K`;
    const bullet = '\u{2022}';
    const sgr = (...args) => `${esc}[${args.join(';')}m`;
    const sgrRgbFg = (...args) => sgr(`38:2:${args.join(':')}`);
    const sgrRgbBg = (...args) => sgr(`48:2:${args.join(':')}`);
    const normal = sgr(0);
    const bold = sgr(1);
    const italic = sgr(3);
    const underline = sgr(4);
    const osc = (...args) => `${esc}]${args.join(';')}${bel}`;
    const osc8 = (uri = '', params = '') => osc(8, params, uri);

    function printPrompt(io) {
      io.print(
        `${bold}` +
        `${sgrRgbFg(0x7a, 0xe9, 0x46)}rv32>` +
        `${normal} `
      );
    }

    var Module = {
      arguments: ["-C", "debug.print_info=1", "-e", "demos/dhrystone.elf"],
      noInitialRun: true,
      totalDependencies: 0,
      completeDownloads: 0,
    };

    var termbuf = "";
    var errcolor = sgrRgbFg(0xee, 0xb2, 0x11);

    function loadEmulator(io) {
      io.println("Loading emulator...");

      Module.print = function (text) { io.println(text); }
      Module.printErr = function (text) { io.println(`${errcolor}${text}${normal}`); }

      Module.monitorRunDependencies = function (left) {
        this.totalDependencies = Math.max(this.totalDependencies, left);
        io.print(`${clrln} Preparing... (` + (this.totalDependencies - left) + '/' + this.totalDependencies + ')\r');
        if (!left) {
          this.completeDownloads += 1;
          io.println(`${clrln}OK: download #${this.completeDownloads} complete\r`);
        }
      }

      Module.onRuntimeInitialized = function () {
        io.println("OK: emulator load (.wasm + all data files) completed");
        io.println('');

        // Update the printErr routine again, so that it has a distinct look
        // from load-time errors
        errcolor = `${sgrRgbFg(0xd5, 0x0f, 0x25)}`;

        const rv32Ver = '@RV32_VERSION@';
        const htermVer = lib.resource.getData('hterm/changelog/version');
        const date = lib.resource.getData('hterm/changelog/date');

        lines = [
          `rv32-sail: version ${bold}${rv32Ver}${normal}`,
          `hterm: version ${bold}${htermVer}${normal} (built on ${bold}${date}${normal})`,
          ``,
          `There are three basic commands:`,
          ``,
          `  ${bullet} ${bold}${underline}ls${normal}, which lists the available demos`,
          `  ${bullet} ${bold}${underline}run${normal} ${underline}<FILENAME>${normal} ${underline}[OPTIONS...]${normal} runs a demo, where`,
          `    ${bullet} ${underline}<FILENAME>${normal} is the name of a demo`,
          `    ${bullet} ${underline}[OPTIONS...]${normal} are optional arguments to pass to ${bold}rv32-sail${normal}`,
          `  ${bullet} ${bold}${underline}clear${normal}, which clears the terminal`,
          ``,
          `For example: try ${bold}run dhrystone.elf -C debug.print_info=1${normal}`,
          ``,
          `Have fun!`,
          ``,
        ];
        lines.forEach((line) => io.println(line));
        printPrompt(io);
      }

      // load actual cruise script
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'cruise.js';
      script.async = true;
      document.body.appendChild(script);
    }

    function initContent(io) {
      let linkify = (uri, txt) => `${underline}${bold}${osc8(uri)}${txt}${osc8()}${normal}`;

      let sailHome = linkify("https://www.cl.cam.ac.uk/~pes20/sail/", "Sail Programming Language");
      let htermHome = linkify("https://hterm.org", "hterm terminal emulator");
      let lines = [
        ``,
        `${bold}rv32-sail: a RISC-V RV32IM emulator, written in Sail${normal}`,
        ``,
        `${bold}rv32-sail${normal} is a full RISC-V emulator for RV32IM in machine`,
        `(M-) mode, written using the ${sailHome}.`,
        `This is a version of the emulator's C code, compiled to`,
        `WebAssembly, equipped with the ${htermHome}.`,
        ``,
      ];
      lines.forEach((line) => io.println(line));

      const topLine = '\u{23ba}';
      const colorTermFg = sgrRgbFg(0x7a, 0xe9, 0x46);
      const colorTermBg = sgrRgbBg(0x10, 0x37, 0x18);
      lines = [
        `  .--~~~~~~~~~~~~~------.`,
        ` /--===============------\\`,
        ` | |${colorTermBg}${topLine.repeat(18)}${normal}|     |`,
        ` | |${colorTermBg}               ${normal}|     |`,
        ` | |${colorTermBg}      ${colorTermFg}>_<      ${normal}|     |`,
        ` | |${colorTermBg}               ${normal}|     |`,
        ` | |${colorTermBg}_______________${normal}|     |`,
        ` |                   ::::|`,
        ` '======================='`,
        ` //-'-'-'-'-'-'-'-'-'-'-\\\\`,
        `//_'_'_'_'_'_'_'_'_'_'_'_\\\\`,
        `[-------------------------]`,
        `\\_________________________/`,
      ];
      lines.forEach((line) => io.println(' '.repeat(20) + line));
      io.println('');

      let links = [
        ['https://github.com/thoughtpolice/rv32-sail/', 'Homepage, Source Code, & Documentation'],
        ['https://github.com/thoughtpolice/rv32-sail/issues', 'Bugs & Feature Requests'],
        ['mailto:aseipp at pobox dot com', 'Contact'],
      ];
      links.forEach(([uri, text]) => io.println(`  ${bullet} ${linkify(uri, text)}`));
      io.println('');
    };

    function processCommand(io, term, input) {
      if (input == '') return;

      var words = input.split(' ').filter(i => i); /* ignore empty '' elements */
      var cmd = words[0];

      // TODO FIXME: why doesn't smoke work?
      var validDemos = ["42", "dhrystone", "forth"]
        .map((f) => f + '.elf');

      switch (cmd) {
        case '': { break; }
        case 'clear': { term.wipeContents(); break; }
        case 'ls': { io.println(validDemos.join(' ')); break; }

        case 'run': {
          if (words.length < 2) {
            io.println("INVALID COMMAND ARGUMENTS: 'run' must have the name of a demo!");
            io.println("Try 'ls' to see which demos you can run.");
            break;
          }

          var demo = words[1];
          if (!validDemos.includes(demo)) {
            io.println("INVALID DEMO NAME: '" + demo + "' does not exist!");
            io.println("Try 'ls' to see which demos you can run.");
            break;
          }
          io.println('Loading demo ' + demo + '...');
          io.println('');

          var args = ["-e", "demos/" + demo];
          if (words.length > 2) args = [].concat(args, words.slice(2));

          console.log(args);
          Module.callMain(args);
          break;
        }

        default:
          io.println("INVALID COMMAND WORD: '" + cmd + "'")
      }
    }

    function setupHterm() {
      // We don't mark it local so people can play with it in the dev console.
      var term = new hterm.Terminal();
      term.onTerminalReady = function () {
        const io = this.io.push();

        io.onVTKeystroke = (string) => {
          switch (string) {
            case '\r':
              io.println('');
              processCommand(io, term, termbuf);
              termbuf = "";
              printPrompt(io);
              break;
            default:
              termbuf += string;
              io.print(string);
              break;
          }
        };

        io.sendString = (string) => {
          termbuf += string;
          io.print(string);
        }

        initContent(io);
        this.setCursorVisible(true);

        this.keyboard.bindings.addBindings({
          // Allow page refreshing.
          'Ctrl-R': 'PASS',
          'Ctrl-Shift-R': 'PASS',
          // Fullscreen shortcut.
          'F11': 'PASS',
        });

        // Just enough to provide an example.
        this.contextMenu.setItems([
          ['Terminal Clear', function () { term.wipeContents(); }],
          ['Terminal Reset', function () { term.reset(); }],
        ]);

        loadEmulator(io);
      };
      term.decorate(document.querySelector('#terminal'));
      term.installKeyboard();

      // Useful for console debugging.
      window.term_ = term;
    }

    function loadHterm() {
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'hterm.js';
      script.onload = function () {
        lib.init(setupHterm);
      };
      document.body.appendChild(script);
    }
    loadHterm();
  </script>
</body>

</html>
